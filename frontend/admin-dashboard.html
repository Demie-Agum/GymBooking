<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Gym Booking System</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/app.js"></script>
    <script src="js/admin.js"></script>
</head>
<body class="dashboard-page" data-theme="light">
    
    <!-- Navbar -->
    <nav class="dashboard-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <h2 id="dashboard-title">Admin - Dashboard</h2>
            </div>
            <div class="nav-menu">
                <a href="admin-dashboard.html" class="btn btn-primary btn-sm">Dashboard</a>
                <a href="admin-users.html" class="btn btn-secondary btn-sm">Manage Users</a>
                <a href="admin-sessions.html" class="btn btn-secondary btn-sm">Manage Sessions</a>
                <a href="admin-bookings.html" class="btn btn-secondary btn-sm">Manage Bookings</a>
                <a href="profile.html" class="btn btn-secondary btn-sm">Profile</a>
                <button id="logoutBtn" class="btn btn-logout btn-sm">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="dashboard-container">
        
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <h1>Admin Dashboard</h1>
                <p id="user-name">Loading...</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="dashboard-section">
            <h2>Statistics</h2>
            <div id="stats-loading" style="text-align: center; padding: 20px; color: #666;">
                Loading statistics...
            </div>
            <div id="stats-grid" class="stats-grid" style="display: none;">
                <div class="stat-card">
                    <h3 id="total-users">-</h3>
                    <p>Total Users</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-bookings">-</h3>
                    <p>Total Bookings</p>
                </div>
                <div class="stat-card">
                    <h3 id="confirmed-bookings">-</h3>
                    <p>Confirmed Bookings</p>
                </div>
                <div class="stat-card">
                    <h3 id="queued-bookings">-</h3>
                    <p>Queued Bookings</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-sessions">-</h3>
                    <p>Total Sessions</p>
                </div>
                <div class="stat-card">
                    <h3 id="upcoming-sessions">-</h3>
                    <p>Upcoming Sessions</p>
                </div>
            </div>
            <div id="stats-error" style="display: none; text-align: center; padding: 20px; color: #ef4444;">
                <p>Failed to load statistics. Please refresh the page.</p>
                <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 10px;">Refresh</button>
            </div>
        </div>

    </div>

    <script>
        // Check authentication and admin role
        document.addEventListener('DOMContentLoaded', async function() {
            if (!apiClient.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Verify admin or super admin role
            try {
                const userResponse = await apiClient.get('/user');
                if (userResponse.success && userResponse.data.success) {
                    const user = userResponse.data.data.user;
                    if (user.role !== 'admin' && user.role !== 'super_admin') {
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    const roleLabel = user.role === 'super_admin' ? 'Super Admin' : 'Admin';
                    document.getElementById('user-name').textContent = `Welcome, ${user.firstname} ${user.lastname}! (${roleLabel})`;
                    
                    // Update dashboard title for Super Admin
                    if (user.role === 'super_admin') {
                        const titleElement = document.getElementById('dashboard-title');
                        if (titleElement) {
                            titleElement.textContent = 'Super Admin - Dashboard';
                        }
                        const headerTitle = document.querySelector('.dashboard-header h1');
                        if (headerTitle) {
                            headerTitle.textContent = 'Super Admin Dashboard';
                        }
                    }
                } else {
                    console.error('Failed to get user data:', userResponse);
                    alert('Failed to load user data. Please login again.');
                    apiClient.removeToken();
                    window.location.href = 'login.html';
                    return;
                }
            } catch (error) {
                console.error('Error checking admin access:', error);
                alert('Authentication error. Please login again.');
                apiClient.removeToken();
                window.location.href = 'login.html';
                return;
            }

            await loadAdminDashboard();
            setupLogout();
        });

        async function loadAdminDashboard() {
            const loadingEl = document.getElementById('stats-loading');
            const statsGrid = document.getElementById('stats-grid');
            const errorEl = document.getElementById('stats-error');
            
            try {
                // Show loading state
                if (loadingEl) loadingEl.style.display = 'block';
                if (statsGrid) statsGrid.style.display = 'none';
                if (errorEl) errorEl.style.display = 'none';

                const response = await apiClient.get('/admin/dashboard/stats');
                
                // Check for 403 Forbidden
                if (response.status === 403) {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                if (response.success && response.data && response.data.success) {
                    const stats = response.data.data || {};
                    document.getElementById('total-users').textContent = stats.total_users ?? 0;
                    document.getElementById('total-bookings').textContent = stats.total_bookings ?? 0;
                    document.getElementById('confirmed-bookings').textContent = stats.confirmed_bookings ?? 0;
                    document.getElementById('queued-bookings').textContent = stats.queued_bookings ?? 0;
                    document.getElementById('total-sessions').textContent = stats.total_sessions ?? 0;
                    document.getElementById('upcoming-sessions').textContent = stats.upcoming_sessions ?? 0;
                    
                    // Hide loading, show stats
                    if (loadingEl) loadingEl.style.display = 'none';
                    if (statsGrid) statsGrid.style.display = 'grid';
                } else {
                    console.error('Failed to load stats:', response);
                    const errorMsg = response.data?.message || response.data?.error || 'Failed to load dashboard statistics';
                    console.error('Error message:', errorMsg);
                    console.error('Response status:', response.status);
                    console.error('Response data:', response.data);
                    
                    // Show error
                    if (loadingEl) loadingEl.style.display = 'none';
                    if (statsGrid) statsGrid.style.display = 'none';
                    if (errorEl) errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading admin dashboard:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    response: error.response
                });
                
                // Show error
                if (loadingEl) loadingEl.style.display = 'none';
                if (statsGrid) statsGrid.style.display = 'none';
                if (errorEl) errorEl.style.display = 'block';
            }
        }

        function setupLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function() {
                    try {
                        await apiClient.post('/logout');
                        apiClient.removeToken();
                        window.location.href = 'login.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                        apiClient.removeToken();
                        window.location.href = 'login.html';
                    }
                });
            }
        }
    </script>
</body>
</html>

